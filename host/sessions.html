<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Host Sessions Calendar</title>
  <link rel="icon" href="../images/futbola-favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/images/backgroundOrangeGradient.jpg');
      padding: 20px;
      margin: 0;
    }
    h2 {
      text-align: center;
      color: #702963;
    }
    #calendarGridWrapper {
      border: 2px solid #702963;
      border-radius: 10px;
      padding: 20px 10px;
      background: white;
      max-width: 640px;
      margin: 0 auto 30px auto;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }
    .calendar-header {
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 8px;
      color: #702963;
    }
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 10px;
    }
    .calendar-box {
      background-color: white;
      border: 2px solid #ff0000;
      border-radius: 6px;
      padding: 8px 4px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      height: 50px;
      cursor: pointer;
      position: relative;
    }
    .dot-container {
      display: flex;
      justify-content: center;
      gap: 2px;
      margin-top: 4px;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    #sessionContainer {
      max-width: 700px;
      margin: auto;
    }
    .session-card {
      background: white;
      border-top: 5px solid #ff5a5f;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .session-header {
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      color: #702963;
      margin-bottom: 10px;
    }
    .session-details {
      display: none;
      margin-top: 10px;
    }
    .session-info p {
      margin: 6px 0;
      font-size: 15px;
    }
    .player-list {
      margin-top: 10px;
    }
    .player-avatar {
      display: inline-block;
      margin: 4px;
      text-align: center;
      position: relative;
      cursor: pointer;
    }
    .player-avatar img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #ff5a5f;
      object-fit: cover;
    }
    .player-avatar.paid img {
      border: 2px solid #4caf50;
    }
    .player-avatar span {
      display: block;
      font-size: 12px;
      max-width: 60px;
      overflow-wrap: break-word;
    }
    .emoji-action {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 50%;
      font-size: 14px;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 18px;
      cursor: pointer;
    }
    .emoji-wa { top: -5px; left: -5px; }
    .emoji-remove { top: -5px; right: -5px; }
    .emoji-paid { bottom: -5px; left: -5px; }
    .emoji-profile { bottom: -5px; right: -5px; }
    .button-bar {
      margin-top: 6px;
    }
    .button-bar button {
      margin-right: 6px;
      margin-top: 4px;
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-btn { background: #702963; color: white; }
    .edit-btn { background: #ff9800; color: white; }
    .track-btn { background: #9c27b0; color: white; }

    /* Phone popover above avatar */
.phone-popover {
  display: none;
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 3px 6px;
  font-size: 11px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  z-index: 3;
  cursor: pointer;
}
.phone-popover::after {
  content: "";
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: #ccc transparent transparent transparent;
}
  </style>
</head>
<body>
<h2>Host Dashboard</h2>

<div id="calendarGridWrapper">
  <div class="calendar-nav">
    <button onclick="prevMonth()">‚¨ÖÔ∏è</button>
    <div class="calendar-header" id="monthLabel">August 2025</div>
    <button onclick="nextMonth()">‚û°Ô∏è</button>
  </div>
  <div id="calendarGrid"></div>
</div>

<div id="sessionContainer"></div>

<a href="/" style="display: block; width: fit-content; margin: 40px auto 0; background-color: #ff0000; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; text-align: center;">
  ‚Üê Back to Homepage
</a>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://kdbqroxhypnadolcxxxc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYnFyb3hoeXBuYWRvbGN4eHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3MjkwNzYsImV4cCI6MjA1NzMwNTA3Nn0.c7_RVxoFdJNqQ62R3t1emH2Wf4dSsQaunHsHmbQxOBA'
  );

  let allGames = [];
  let bookingMap = {};
  let user = null;

  const { data: userData } = await supabase.auth.getUser();
  user = userData.user;

  const monthLabel = document.getElementById("monthLabel");
  const calendarGrid = document.getElementById("calendarGrid");
  const sessionContainer = document.getElementById("sessionContainer");

  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();

  async function fetchGamesAndBookings() {
    const today = new Date().toISOString().split("T")[0];

    const { data: games, error: gameError } = await supabase
        .from("games")
        .select("*")
        .order("game_date", { ascending: true });

    if (gameError) {
        console.error("Error fetching games:", gameError);
        return;
    }

    allGames = games || [];

    // Fetch bookings
    const { data: bookings, error: bookingError } = await supabase
        .from("game_bookings")
        .select("game_id");

    if (bookingError) {
        console.error("Error fetching bookings:", bookingError);
        return;
    }

    // Count players per game_id
    bookingMap = {};
    bookings.forEach(b => {
        bookingMap[b.game_id] = (bookingMap[b.game_id] || 0) + 1;
    });

    console.log("Games loaded:", allGames);
    console.log("Booking counts:", bookingMap);

    renderCalendar(currentMonth, currentYear);
    }

    async function loadPlayers(gameId, containerEl) {
        const target = containerEl.querySelector(".player-list");

        const [{ data: bookings }, { data: game }] = await Promise.all([
            supabase
            .from("game_bookings")
            .select("*, profiles (jersey_name, avatar_url)")
            .eq("game_id", gameId),
            supabase
            .from("games")
            .select("max_players")
            .eq("id", gameId)
            .single()
        ]);
        console.log(`üßç Loaded ${bookings.length} players for ${gameId}`, bookings);

        if (!bookings || !game) {
        console.warn("‚ö†Ô∏è Missing data:", { bookings, game });
        target.innerHTML = "<p style='text-align:center; color:#999;'>Failed to load players</p>";
        return;
        }

        const html = bookings.map(b => {
            const label = b.profiles?.jersey_name || b.jersey_name || 'Player';
            const avatar = b.profiles?.avatar_url || b.avatar_url || '/images/default-avatar.png';
            const isPaid = b.paid;

            return `
<div class="player-avatar ${isPaid ? 'paid' : ''}" data-booking-id="${b.id}" onclick="toggleEmojiActions(this)">
    <div class="phone-popover" data-orig="${b.phone ? b.phone : 'No phone'}" onclick="copyPhone(this)">${b.phone ? b.phone : 'No phone'}</div>
    <img src="${avatar}" onerror="this.src='/images/default-avatar.png'" />
                <span>${label}</span>
                <div class="emoji-action emoji-wa" title="WhatsApp"
  onclick="event.stopPropagation(); ${b.phone ? `openWa('${b.phone}')` : `alert('No phone number available')`}">üìû</div>
                <div class="emoji-action emoji-remove" title="Remove Player" onclick="event.stopPropagation(); removePlayer('${b.id}', this)">‚ùå</div>
                <div class="emoji-action emoji-paid"
     title="Toggle Paid"
     onclick="event.stopPropagation(); togglePaid(this); hideEmojiActions(this.closest('.player-avatar'));">üí∞</div>
                <div class="emoji-action emoji-profile" title="Profile"
  onclick="event.stopPropagation(); ${b.user_id ? `window.open('/player-public.html?id=${b.user_id}', '_blank')` : `alert('No profile available')`}">üë§</div>
            </div>
            `;
        }).join("");

        target.innerHTML = html;

        const count = bookings.length;
        const max = game.max_players;
        const statusEl = containerEl.querySelector(".session-header");
        if (count >= max) {
            statusEl.innerHTML += ` <span style="color:gray;">‚ùå FULL (${count}/${max})</span>`;
        } else {
            statusEl.innerHTML += ` <span style="color:#4caf50;">‚úÖ ${count}/${max} joined</span>`;
        }
        }

  function renderCalendar(month, year) {
    calendarGrid.innerHTML = "";
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const monthName = firstDay.toLocaleDateString("en-MY", { month: 'long' });
    monthLabel.textContent = `${monthName} ${year}`;

    const dayOffset = firstDay.getDay();
    for (let i = 0; i < dayOffset; i++) {
      const empty = document.createElement("div");
      calendarGrid.appendChild(empty);
    }

    const today = new Date();  
    today.setHours(0, 0, 0, 0);

    for (let d = 1; d <= lastDay.getDate(); d++) {
      const box = document.createElement("div");
      box.className = "calendar-box";

        const thisDate = new Date(year, month, d);
        thisDate.setHours(0, 0, 0, 0);

        if (thisDate < today) {
        box.style.opacity = 0.4;
        }
      const dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        const sessions = allGames.filter(g => g.game_date === dateStr);

        let dots = "";
        sessions.forEach(g => {
        let status = "green"; // default
        const booked = bookingMap[g.id] || 0;
        if (booked >= g.max_players) status = "red";
        else if (booked >= 0.7 * g.max_players) status = "orange";
        dots += `<span class='dot' style='background-color: ${status};'></span>`;
        });

        box.innerHTML = `${d}<div class='dot-container'>${dots}</div>`;
      box.onclick = () => loadSessionsForDate(year, month + 1, d);
      calendarGrid.appendChild(box);
    }
    console.log("Rendering with games:", allGames);
  }


  function loadSessionsForDate(year, month, day) {
        sessionContainer.innerHTML = '';

        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const sessions = allGames.filter(g => g.game_date === dateStr);

        if (sessions.length === 0) {
        sessionContainer.innerHTML = "<p style='text-align:center;'>No sessions on this date.</p>";
        return;
        }

    (async () => {
  for (const game of sessions) {
    const card = document.createElement("div");
    card.className = "session-card";

    card.innerHTML = `
        <div class="session-header">
        ‚ñ∂Ô∏è ${game.session_title || 'Untitled'} ‚Äì ${game.game_date}
        </div>
        <div class="session-details" style="display: none;">

  <!-- VIEW MODE -->
  <div class="session-info view-only">
    <p><strong>üìõ Title:</strong> ${game.session_title || 'Untitled'}</p>
    <p><strong>üìç Venue:</strong> ${game.venue}</p>
    <p><strong>üìÖ Date:</strong> ${game.game_date}</p>
    <p><strong>üïí Time:</strong> ${game.start_time} ‚Äì ${game.end_time}</p>
    <p><strong>üí∞ Price:</strong> RM ${parseFloat(game.price || 0).toFixed(2)}</p>
    <p><strong>üì∂ Level:</strong> ${game.level || '-'}</p>
    <p><strong>üßÆ Format:</strong> ${game.play_style || '-'}</p>
    <p><strong>üèüÔ∏è Teams:</strong> ${game.teams || '-'}</p>
    <p><strong>üïπÔ∏è Courts:</strong> ${game.courts || '-'}</p>
    <p><strong>‚è±Ô∏è Minutes:</strong> ${game.minutes || '-'}</p>
    <p><strong>üë• Max Players:</strong> ${game.max_players}</p>
    <p><strong>üí≥ Payment:</strong> ${game.payment_type || '-'}</p>
    <p><strong>üì≤ Contact:</strong> ${game.contact_method || '-'}</p>
    <p><strong>üîó Contact Link:</strong> <a href="${game.contact_link || '#'}" target="_blank">Join Group</a></p>
  </div>

  <!-- EDIT MODE -->
  <div class="session-info edit-only" style="display: none;">
    <p><strong>üìõ Title:</strong> <input name="session_title" value="${game.session_title || ''}" /></p>
    <p><strong>üìç Venue:</strong> <input name="venue" value="${game.venue || ''}" /></p>
    <p><strong>üìÖ Date:</strong> <input name="game_date" type="date" value="${game.game_date || ''}" /></p>
    <p><strong>üïí Start Time:</strong> <input name="start_time" type="time" value="${game.start_time || ''}" /></p>
    <p><strong>üïí End Time:</strong> <input name="end_time" type="time" value="${game.end_time || ''}" /></p>
    <p><strong>üí∞ Price:</strong> <input name="price" type="number" step="0.01" value="${game.price || ''}" /></p>
    <p><strong>üì∂ Level:</strong> <input name="level" value="${game.level || ''}" /></p>
    <p><strong>üßÆ Format:</strong> <input name="play_style" value="${game.play_style || ''}" /></p>
    <p><strong>üèüÔ∏è Teams:</strong> <input name="teams" type="number" value="${game.teams || ''}" /></p>
    <p><strong>üïπÔ∏è Courts:</strong> <input name="courts" type="number" value="${game.courts || ''}" /></p>
    <p><strong>‚è±Ô∏è Minutes:</strong> <input name="minutes" type="number" value="${game.minutes || ''}" /></p>
    <p><strong>üë• Max Players:</strong> <input name="max_players" type="number" value="${game.max_players || ''}" /></p>
    <p><strong>üí≥ Payment:</strong> 
      <select name="payment_type">
        <option value="">Select Payment</option>
        <option value="pay_on_court" ${game.payment_type === 'pay_on_court' ? 'selected' : ''}>Pay on Court</option>
        <option value="online_transfer" ${game.payment_type === 'online_transfer' ? 'selected' : ''}>Online Transfer</option>
      </select>
    </p>
    <p><strong>üì≤ Contact:</strong> <input name="contact_method" value="${game.contact_method || ''}" /></p>
    <p><strong>üîó Contact Link:</strong> <input name="contact_link" value="${game.contact_link || ''}" /></p>
  </div>

  <!-- Player List + Buttons will go here after this -->
<div class="player-list">
    <p style="text-align:center; color:#999;">Players will appear here</p>
</div>
    <div class="add-player-form" style="display: none; margin-top: 10px;">
        <input type="text" placeholder="Jersey Name" class="jersey-input" />
        <input type="text" placeholder="Phone (60123456789)" class="phone-input" />
        <button class="confirm-add-btn">Add</button>
    </div>
        <div class="button-bar">
            <button class="add-btn">+ Add Player</button>
            <button class="edit-btn">Edit Session</button>
            <button class="track-btn public-result-btn">üìä Public Results</button>
        </div>
</div>
        
        </div>
    `;

    const header = card.querySelector(".session-header");
    header.addEventListener("click", () => {
        const details = header.nextElementSibling;
        const isVisible = details.style.display === 'block';
        details.style.display = isVisible ? 'none' : 'block';
        header.innerText = (isVisible ? '‚ñ∂Ô∏è' : 'üîΩ') + ' ' + header.innerText.slice(2);
    });

    const editBtn = card.querySelector(".edit-btn");
        editBtn.addEventListener("click", () => {
        const viewBlock = card.querySelector(".session-info:not(.edit-only)");
        const editBlock = card.querySelector(".session-info.edit-only");
        const saveBtn = document.createElement("button");
        const cancelBtn = document.createElement("button");

        // Hide view, show edit
        viewBlock.style.display = "none";
        editBlock.style.display = "block";

        // Remove "Edit" button
        editBtn.style.display = "none";

        // Add Save/Cancel
        saveBtn.textContent = "üíæ Save";
        saveBtn.className = "save-btn";
        cancelBtn.textContent = "‚ùå Cancel";
        cancelBtn.className = "cancel-btn";
        card.querySelector(".button-bar").appendChild(saveBtn);
        card.querySelector(".button-bar").appendChild(cancelBtn);

        // Hook Save/Cancel actions
        saveBtn.onclick = () => saveSession(game.id, card);
        cancelBtn.onclick = () => location.reload();
    });

    sessionContainer.appendChild(card);
    // üëá Fetch session_id for this game
const resultBtn = card.querySelector(".public-result-btn");

(async () => {
  try {
    const { data: sessionsData, error } = await supabase
      .from("games_sessions")
      .select("id")
      .eq("game_id", game.id)
      .maybeSingle();

    const sessionId = sessionsData?.id;

    if (sessionId) {
      resultBtn.onclick = () => {
        window.open(`/current-games/public-match-results.html?session=${sessionId}`, "_blank");
      };
    } else {
  resultBtn.textContent = "‚öôÔ∏è Setup Game";
  resultBtn.onclick = () => {
    window.open(`/current-games/start-game.html`, "_blank");
  };
  }

    if (error) {
      console.error("‚ùå Error fetching session ID:", error);
    }
  } catch (err) {
    console.error("‚ùå Unexpected error:", err);
  }
})();

    const addBtn = card.querySelector(".add-btn");
    const confirmBtn = card.querySelector(".confirm-add-btn");

    addBtn.addEventListener("click", () => toggleAddForm(card));
    confirmBtn.addEventListener("click", () => addPlayer(game.id, card));
    sessionContainer.appendChild(card);
    await loadPlayers(game.id, card); // ‚úÖ Now works without error
  }
})();
  }

  function prevMonth() {
    if (currentMonth === 0) {
      currentMonth = 11;
      currentYear--;
    } else {
      currentMonth--;
    }
    renderCalendar(currentMonth, currentYear);
  }

  function nextMonth() {
    if (currentMonth === 11) {
      currentMonth = 0;
      currentYear++;
    } else {
      currentMonth++;
    }
    renderCalendar(currentMonth, currentYear);
  }

  function toggleDetails(headerEl) {
    const details = headerEl.nextElementSibling;
    const isVisible = details.style.display === 'block';
    details.style.display = isVisible ? 'none' : 'block';
    headerEl.innerText = (isVisible ? '‚ñ∂Ô∏è' : 'üîΩ') + ' ' + headerEl.innerText.slice(2);
  }

function hideAllPhonePopovers() {
  document.querySelectorAll('.phone-popover').forEach(p => {
    p.style.display = 'none';
    if (p._timer) clearTimeout(p._timer);
  });
}

function toggleEmojiActions(playerEl) {
  const actions = playerEl.querySelectorAll('.emoji-action');
  const show = actions[0].style.display !== 'block';
  actions.forEach(a => a.style.display = show ? 'block' : 'none');

  // Show phone popover for 15s when opening actions
  const pop = playerEl.querySelector('.phone-popover');
  if (pop) {
    if (show) {
      hideAllPhonePopovers();
      pop.style.display = 'block';
      if (pop._timer) clearTimeout(pop._timer);
      pop._timer = setTimeout(() => {
        pop.style.display = 'none';
      }, 15000); // 15 seconds
    } else {
      pop.style.display = 'none';
      if (pop._timer) clearTimeout(pop._timer);
    }
  }
}

function copyPhone(el) {
  const val = (el.textContent || '').trim();
  if (!val || val === 'No phone') return;
  const orig = el.getAttribute('data-orig') || val;
  navigator.clipboard?.writeText(val).then(() => {
    el.textContent = 'Copied!';
    setTimeout(() => { el.textContent = orig; }, 800);
  });
}

  function hideEmojiActions(playerEl) {
  const actions = playerEl.querySelectorAll('.emoji-action');
  actions.forEach(a => a.style.display = 'none');
}

function normalizePhoneForWa(raw) {
  if (!raw) return "";
  // Keep digits and +, strip spaces/dashes/other punctuation
  let s = String(raw).trim().replace(/[^\d+]/g, "");
  // Drop leading +
  if (s.startsWith("+")) s = s.slice(1);

  // Already has Malaysia code
  if (s.startsWith("60")) {
    // ok
  } else if (s.startsWith("0")) {
    // Local format like 0123456789 -> 60123456789
    s = "60" + s.slice(1);
  } else if (s.startsWith("1")) {
    // Missing leading 0/60, assume mobile -> 601...
    s = "60" + s;
  }

  // Final guard: wa.me expects digits only; length sanity (9‚Äì15)
  if (!/^\d{9,15}$/.test(s)) return "";
  return s;
}

function openWa(raw) {
  const n = normalizePhoneForWa(raw);
  if (n) {
    window.open("https://wa.me/" + n, "_blank");
  } else {
    alert("Invalid phone number");
  }
}

async function togglePaid(el) {
  const avatarEl = el.closest('.player-avatar');
  const bookingId = avatarEl.getAttribute('data-booking-id');
  console.log("üÜî Booking ID received:", bookingId);
  if (!bookingId) {
    console.error("‚ùå No booking ID found for payment toggle.");
    return;
  }

const isNowPaid = !avatarEl.classList.contains('paid');
console.log(`üí∞ Toggling payment for booking ID: ${bookingId}, new paid status: ${isNowPaid}`);

// Optimistic UI update
avatarEl.classList.toggle('paid');

// Send update to Supabase and return the updated row
const { data, error } = await supabase
  .from('game_bookings')
  .update({ paid: isNowPaid })
  .eq('id', bookingId)
  .select();  // ‚úÖ This retrieves the updated record

if (error) {
  console.error("‚ùå Error saving paid status:", error);
  alert("‚ùå Failed to save paid status.");
  // Rollback UI on failure
  avatarEl.classList.toggle('paid');
} else {
  console.log("‚úÖ Paid status saved successfully:", data);  // ‚úÖ Inspect what's saved
}
}

async function saveSession(gameId, card) {
  console.log("üíæ saveSession triggered for:", gameId);

  const formInputs = card.querySelectorAll(".edit-only [name]");
  console.log("üîç Collecting input values...");

  const updates = {};

  formInputs.forEach(input => {
    const key = input.name;
    let val = input.value;

    if (input.type === "number") {
      val = input.value === "" ? null : parseFloat(val); 
    } else if (input.type === "date" || input.type === "time") {
      val = input.value || null;
    } else {
      val = input.value.trim() === "" ? null : input.value;
    }

    updates[key] = val;
  });

  console.log("üì¶ Payload to save:", updates); // Moved after loop

  const { error } = await supabase
    .from("games")
    .update(updates)
    .eq("id", gameId);

  if (error) {
    console.error("‚ùå Supabase error:", error);
    alert("‚ùå Error saving: " + error.message);
  } else {
    console.log("‚úÖ Successfully saved");
    alert("‚úÖ Saved successfully!");
    fetchAndRender(); // ‚Üê re-renders fresh data
  }

  // After saving, revert to view-only mode
card.querySelector(".edit-only").style.display = "none";
card.querySelector(".session-info").style.display = "block";

// Optionally, change button visibility
card.querySelector(".save-btn").style.display = "none";
card.querySelector(".cancel-btn").style.display = "none";
card.querySelector(".edit-btn").style.display = "inline-block";
}

async function fetchAndRender() {
  const { data: userData } = await supabase.auth.getUser();
  user = userData.user;

  await fetchGamesAndBookings();           // ‚Üê FIXED this line
  renderCalendar(currentMonth, currentYear);  // refresh calendar UI
}

async function removePlayer(bookingId, el) {
  const confirmDelete = confirm("Are you sure you want to remove this player?");
  if (!confirmDelete) return;

  console.log("üóëÔ∏è Removing booking ID:", bookingId);

  const { error } = await supabase
    .from("game_bookings")
    .delete()
    .eq("id", bookingId);

  if (error) {
    console.error("‚ùå Failed to remove player:", error);
    alert("Error removing player.");
  } else {
    console.log("‚úÖ Player removed from Supabase.");
    el.closest(".player-avatar").remove(); // Remove from UI
  }
}

async function addPlayer(gameId, card) {
  const jerseyInput = card.querySelector(".jersey-input");
  const phoneInput = card.querySelector(".phone-input");
  const form = card.querySelector(".add-player-form");
  const name = jerseyInput.value.trim();
  const phone = phoneInput.value.trim();

  if (!name) {
    alert("Please enter a jersey name");
    return;
  }

  const { error } = await supabase.from("game_bookings").insert({
    game_id: gameId,
    jersey_name: name,
    phone
  });

  if (error) {
    console.error("‚ùå Failed to add player:", error);
    alert("Error adding player.");
  } else {
    console.log("‚úÖ Player added.");

    // ‚úÖ Clear inputs
    jerseyInput.value = "";
    phoneInput.value = "";

    // ‚úÖ Hide the form
    if (form) form.style.display = "none";

    // ‚úÖ Reload players
    await loadPlayers(gameId, card);
    fetchAndRender(); // Optional: if you want to re-render whole page
  }
}

function toggleAddForm(card) {
  const form = card.querySelector(".add-player-form");
  form.style.display = form.style.display === "block" ? "none" : "block";
}

  await fetchGamesAndBookings();
  window.prevMonth = prevMonth;
  window.nextMonth = nextMonth;
  window.toggleEmojiActions = toggleEmojiActions;
  window.saveSession = saveSession;
  window.togglePaid = togglePaid;
  window.removePlayer = removePlayer;
  window.hideEmojiActions = hideEmojiActions;
  window.addPlayer = addPlayer;
  window.toggleAddForm = toggleAddForm;
  window.hideAllPhonePopovers = hideAllPhonePopovers;
  window.copyPhone = copyPhone;
  window.normalizePhoneForWa = normalizePhoneForWa;
  window.openWa = openWa;
</script>

</body>
</html>