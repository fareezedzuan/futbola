<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Game</title>
  <link rel="icon" href="./images/futbola-favicon.ico" type="image/x-icon">
  <style>
    :root { --brand:#ff5a5f; --accent:#702963; --ink:#111827 }
    *{box-sizing:border-box}
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-image: url('./images/backgroundOrangeGradient.jpg');
      display:flex; justify-content:center; align-items:center; min-height:100vh;
      margin:0; padding:16px;
    }
    .container {
      background:#fff; padding:24px; border-radius:12px; width:100%; max-width:560px;
      box-shadow:0 10px 30px rgba(0,0,0,.08); border-top:5px solid var(--brand);
    }
    h2{ color:var(--accent); margin:0 0 14px; font-weight:800; text-align:center }
    label{ display:block; margin-top:12px; font-weight:700; color:var(--brand) }
    input, select{
      width:100%; padding:10px; margin-top:6px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .hint{ color:#64748b; font-size:12px; margin-top:6px }
    .divider{ height:1px; background:#eee; margin:14px 0 }
    .card{ margin-top:14px; border:1px solid #eee; border-radius:12px; padding:12px; background:#fafafa }
    .card h4{ margin:0 0 8px; color:#111 }
    .pill{ background:#f1f5f9; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; font-size:12px }
    .pos-row{ display:grid; grid-template-columns: 1fr 100px 120px; gap:10px; align-items:center; margin-top:8px }
    .pos-row input[type=number]{ text-align:center }
    .grid2{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px }
    .hidden{ display:none !important }
    button{ background:#ff0000; color:#fff; padding:12px 15px; border:none; border-radius:10px; font-size:18px; margin-top:18px; cursor:pointer; width:100% }
    button:hover{ background:#cc0000 }

    /* Segmented control (Game Type) */
    .seg { display:flex; gap:0; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; margin-top:6px }
    .seg button{
      flex:1; padding:10px; background:#fff; color:#334155; border:0; cursor:pointer; font-weight:700
    }
    .seg button.active{ background: #ffe4e6; color:#991b1b }
    .seg button + button{ border-left:1px solid #e5e7eb }

    /* Toggle switch */
    .toggle{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px }
    .switch{
      position:relative; width:46px; height:28px; background:#e5e7eb; border-radius:999px; transition:.2s; cursor:pointer
    }
    .switch::after{
      content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; background:#fff; border-radius:50%; transition:.2s;
      box-shadow:0 1px 3px rgba(0,0,0,.2)
    }
    .switch.on{ background:#16a34a }
    .switch.on::after{ left:21px }
    .toggle small{ color:#64748b }

    /* Pitch preview */
    .pitch-wrap{ position:relative; width:100%; aspect-ratio:16/10; background:#2f8d3a; border-radius:12px; overflow:hidden; box-shadow:inset 0 0 0 2px #e5ffe5; }
    .pitch-lines{ position:absolute; inset:6% 3%; border:2px solid #fff; border-radius:8px; }
    .pitch-lines::before{ content:""; position:absolute; left:50%; top:0; bottom:0; width:2px; background:#fff; transform:translateX(-50%); }
    .pitch-circle{ position:absolute; left:50%; top:50%; width:24%; aspect-ratio:1; border:2px solid #fff; border-radius:50%; transform:translate(-50%,-50%) }
    .goal{ position:absolute; width:22%; height:8%; border:2px solid #fff; left:50%; transform:translateX(-50%) }
    .goal.top{ top:6%; border-bottom:none } .goal.bottom{ bottom:6%; border-top:none }
    .pv-pos{ position:absolute; transform:translate(-50%,-50%); display:flex; flex-direction:column; align-items:center; gap:6px }
    .pv-slot{ width:42px; height:42px; border-radius:50%; border:3px solid rgba(255,255,255,.95); background:rgba(255,255,255,.12); overflow:hidden; display:grid; place-items:center }
    .pv-slot.empty{ border-style:dashed; opacity:.65 }
    .pv-slot img{ width:100%; height:100%; object-fit:cover }
    .pv-label{ color:#fff; font:600 11px/1.1 system-ui; text-shadow:0 1px 1px rgba(0,0,0,.6) }
    .pv-legend{ display:flex; gap:14px; align-items:center; font-size:12px; color:#334155; margin-top:8px }
    .pv-dot{ width:12px; height:12px; border-radius:50%; display:inline-block; border:2px solid #0a7d2f; background:#0a7d2f }
    .pv-dot.empty{ border-color:#cbd5e1; background:#e2e8f0 }
    @media (max-width:520px){ .pv-slot{ width:34px; height:34px } }
  </style>
</head>
<body>
  <div class="container">
    <h2>Create a New Game</h2>

    <form id="createGameForm">
      <label for="session_title">Session Title</label>
      <input id="session_title" placeholder="e.g. Futbola CF Friday Night" required />

      <label for="venue">Venue</label>
      <input type="text" id="venue" name="venue" placeholder="e.g. Bangi Uptown Sports" required />

      <div class="row">
        <div>
          <label for="game_date">Game Date</label>
          <input type="date" id="game_date" name="game_date" required />
        </div>
        <div>
          <label for="level">Level</label>
          <select id="level" name="level" required>
            <option value="" disabled selected>Select</option>
            <option value="casual">Casual</option>
            <option value="semi-competitive">Semi-Competitive</option>
            <option value="competitive">Competitive</option>
            <option value="any">All welcome</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="start_time">Start</label>
          <input type="time" id="start_time" name="start_time" required />
        </div>
        <div>
          <label for="end_time">End</label>
          <input type="time" id="end_time" name="end_time" required />
        </div>
      </div>

      <label for="play_style">Play Style / Format</label>
      <input type="text" id="play_style" name="play_style" placeholder="e.g. 5-a-side, 3 teams rotation" required>

      <div class="row">
        <div>
          <label for="price">Price (RM)</label>
          <input type="number" id="price" name="price" min="0" step="0.01" placeholder="e.g. 35.00" required />
        </div>
        <div>
          <label for="max_players">Max Players</label>
          <input type="number" id="max_players" name="max_players" min="1" max="120" required />
        </div>
      </div>

      <div class="divider"></div>

      <!-- Segmented: Game Type -->
      <label>Game Type</label>
      <div class="seg" id="gameTypeSeg">
        <button type="button" data-val="futsal" class="active">Futsal</button>
        <button type="button" data-val="football">Football (11v11)</button>
      </div>
      <p class="hint">Football enables Team & Position booking.</p>

      <!-- Toggles -->
      <div class="toggle">
        <div>
          <strong>Team Selection</strong><br/>
          <small>Players choose Team A or Team B.</small>
        </div>
        <div class="switch" id="teamSwitch" role="switch" aria-checked="false"></div>
      </div>

      <div class="toggle">
        <div>
          <strong>Position Selection</strong><br/>
          <small>Players book by GK/DEF/MID/FWD (with caps).</small>
        </div>
        <div class="switch" id="posSwitch" role="switch" aria-checked="false"></div>
      </div>

      <div class="toggle">
        <div>
          <strong>Public</strong><br/>
          <small>Show this session on public listing.</small>
        </div>
        <div class="switch" id="publicSwitch" role="switch" aria-checked="true"></div>
      </div>

      <div class="toggle">
        <div>
          <strong>Recurring</strong><br/>
          <small>Repeat this session weekly.</small>
        </div>
        <div class="switch" id="recurringSwitch" role="switch" aria-checked="false"></div>
      </div>

      <!-- Recurring details -->
      <div id="recurringCard" class="card hidden">
        <h4>Recurring (Weekly)</h4>
        <div class="row">
          <div>
            <label style="color:#374151;font-weight:600">Repeat on</label>
            <div id="weekdaySeg" class="seg" style="margin-top:6px; display:grid; grid-template-columns:repeat(7,1fr)">
              <!-- buttons injected -->
            </div>
          </div>
          <div>
            <label style="color:#374151;font-weight:600">Occurrences</label>
            <input type="number" id="recurrences" min="1" max="52" value="8"/>
            <p class="hint">How many weeks to repeat?</p>
          </div>
        </div>
      </div>

      <!-- Team names -->
      <div id="teamNamesCard" class="card hidden">
        <h4>Team Names</h4>
        <div class="row">
          <div>
            <label for="team_a_name" style="color:#374151;font-weight:600">Team A</label>
            <input id="team_a_name" placeholder="e.g. Futbola CF" />
          </div>
          <div>
            <label for="team_b_name" style="color:#374151;font-weight:600">Team B</label>
            <input id="team_b_name" placeholder="e.g. Visitors" />
          </div>
        </div>
      </div>

      <!-- Position Config -->
      <div id="positionCard" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h4>Football Positions & Limits</h4>
          <span class="pill" id="totalSlotsPill">Total Slots: 0</span>
        </div>
        <p class="hint">Default preset is 4-3-3: GK (1), CB (2), LB, RB, DM, CM (2), LW, RW, ST — each with 2 players; + 3 subs.</p>

        <div class="pos-row" style="font-weight:700;color:#374151;margin-top:0">
          <div>Position (label)</div>
          <div>Positions</div>
          <div>Players / Position</div>
        </div>
        <div id="posRows"></div>

        <div class="divider"></div>
        <div class="grid2">
          <div><strong>Super Subs</strong> <span class="hint">(any position)</span></div>
          <input type="number" id="subs_total" min="0" max="30" value="3"/>
        </div>

        <div class="divider"></div>
        <div>
          <div class="pv-legend">
            <span class="pv-dot"></span> Booked
            <span class="pv-dot empty"></span> Empty
            <span class="hint">Preview (Team A)</span>
          </div>
          <div id="pitchPreview" class="pitch-wrap" aria-label="Pitch preview">
            <div class="pitch-lines"></div>
            <div class="pitch-circle"></div>
            <div class="goal top"></div>
            <div class="goal bottom"></div>
          </div>
        </div>

        <p class="hint">Common preset → 11 positions × 2 players each (22) + 3 subs = <strong>25</strong> total.</p>
      </div>

      <button type="button" id="submitGameButton">Create Game</button>
    </form>
  </div>

  <script>
    // --- Elements
    const segGameType = document.getElementById('gameTypeSeg');
    const teamSwitch  = document.getElementById('teamSwitch');
    const posSwitch   = document.getElementById('posSwitch');
    const publicSwitch= document.getElementById('publicSwitch');
    const recurSwitch = document.getElementById('recurringSwitch');

    const teamCard = document.getElementById('teamNamesCard');
    const posCard  = document.getElementById('positionCard');
    const recurCard= document.getElementById('recurringCard');

    const totalPill= document.getElementById('totalSlotsPill');
    const subsEl   = document.getElementById('subs_total');
    const posRowsEl= document.getElementById('posRows');
    const maxPlayersEl = document.getElementById('max_players');

    // Weekday segmented buttons
    const weekdays = ['S','M','T','W','T','F','S'];
    const weekdaySeg = document.getElementById('weekdaySeg');
    const selectedDays = new Set();
    function renderWeekdays(){
      weekdaySeg.innerHTML = '';
      weekdays.forEach((d,i)=>{
        const b = document.createElement('button');
        b.type='button'; b.dataset.idx=i; b.textContent=d;
        b.style.padding='8px'; b.style.border='0'; b.style.cursor='pointer';
        b.style.background= selectedDays.has(i)? '#dcfce7':'#fff';
        b.style.color= selectedDays.has(i)? '#065f46':'#334155';
        b.addEventListener('click',()=>{
          if (selectedDays.has(i)) selectedDays.delete(i); else selectedDays.add(i);
          renderWeekdays();
        });
        weekdaySeg.appendChild(b);
      });
    }
    renderWeekdays();

    // Segmented game type state
    let gameType = 'futsal';
    segGameType.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        segGameType.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        gameType = btn.dataset.val;
        refreshVisibility();
        updateTotals();
      });
    });

    // Switch helpers
    function toggleSwitch(el, on){
      el.classList.toggle('on', on);
      el.setAttribute('aria-checked', on ? 'true' : 'false');
    }
    function isOn(el){ return el.getAttribute('aria-checked') === 'true' }

    // Init defaults
    toggleSwitch(publicSwitch, true);
    toggleSwitch(teamSwitch, false);
    toggleSwitch(posSwitch, false);
    toggleSwitch(recurSwitch, false);

    [teamSwitch, posSwitch, publicSwitch, recurSwitch].forEach(sw=>{
      sw.addEventListener('click', ()=> {
        toggleSwitch(sw, !isOn(sw));
        refreshVisibility();
        updateTotals();
      });
    });

    // Position preset
    const PRESET = [
      { key:'GK',  label:'GK',  positions:1, players:2 },
      { key:'CB',  label:'CB',  positions:2, players:2 },
      { key:'LB',  label:'LB',  positions:1, players:2 },
      { key:'RB',  label:'RB',  positions:1, players:2 },
      { key:'DM',  label:'DM',  positions:1, players:2 },
      { key:'CM',  label:'CM',  positions:2, players:2 },
      { key:'LW',  label:'LW',  positions:1, players:2 },
      { key:'RW',  label:'RW',  positions:1, players:2 },
      { key:'ST',  label:'ST',  positions:1, players:2 },
    ];
    let state = { positions: JSON.parse(JSON.stringify(PRESET)), subs: 3 };

    function clampInt(v,min,max){ v=parseInt(v||0,10); return isNaN(v)?min:Math.max(min,Math.min(max,v)); }

    function renderPosRows(){
      posRowsEl.innerHTML = '';
      state.positions.forEach((p,idx)=>{
        const row = document.createElement('div');
        row.className = 'pos-row';
        row.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px">
            <span class="pill">${p.key}</span>
            <input value="${p.label}" aria-label="${p.key} label"/>
          </div>
          <input type="number" min="0" max="11" value="${p.positions}" aria-label="${p.key} positions"/>
          <input type="number" min="0" max="10" value="${p.players}" aria-label="${p.key} players"/>
        `;
        const [labelEl, posCountEl, playersEl] = row.querySelectorAll('input');
        labelEl.addEventListener('input', e => { state.positions[idx].label = e.target.value; updateTotals(); });
        posCountEl.addEventListener('input', e => { state.positions[idx].positions = clampInt(e.target.value,0,11); updateTotals(); });
        playersEl.addEventListener('input', e => { state.positions[idx].players = clampInt(e.target.value,0,10); updateTotals(); });
        posRowsEl.appendChild(row);
      });
    }

    // Totals + suggest max_players
    function updateTotals(){
      state.subs = clampInt(subsEl.value,0,30);
      const total = state.positions.reduce((sum,p)=> sum + (p.positions * p.players), 0) + state.subs;
      totalPill.textContent = `Total Slots: ${total}`;
      // Suggest max_players when football + position selection
      if (gameType==='football' && isOn(posSwitch)){
        if (!maxPlayersEl.value || +maxPlayersEl.value < total) maxPlayersEl.value = total;
      }
      renderPitchPreview();
    }

    function refreshVisibility(){
      teamCard.classList.toggle('hidden', !isOn(teamSwitch));
      const showPos = (gameType==='football' && isOn(posSwitch));
      posCard.classList.toggle('hidden', !showPos);
      recurCard.classList.toggle('hidden', !isOn(recurSwitch));
    }

    // Pitch preview utils (Team A)
    function buildPreviewSlots(cfg){
      const out=[]; const Y={F:22,M:48,D:72,GK:88};
      const get = k => cfg.positions.find(p=>p.key===k) || {positions:0,players:0};
      const pushMany=(prefix,n,xs,y)=>{ const X=distribute(n,xs[0],xs[1]); for(let i=0;i<n;i++) out.push({key:`${prefix}${n>1?i+1:""}`,x:X[i],y}) };
      // Forwards
      if(get('LW').positions) pushMany('LW',get('LW').positions,[14,30],Y.F);
      if(get('ST').positions) pushMany('ST',get('ST').positions,[46,54],Y.F);
      if(get('RW').positions) pushMany('RW',get('RW').positions,[70,86],Y.F);
      // Midfield
      if(get('DM').positions) pushMany('DM',get('DM').positions,[40,60],Y.M+4);
      if(get('CM').positions) pushMany('CM',get('CM').positions,[32,68],Y.M);
      // Defense
      if(get('LB').positions) pushMany('LB',get('LB').positions,[14,28],Y.D);
      if(get('CB').positions) pushMany('CB',get('CB').positions,[36,64],Y.D);
      if(get('RB').positions) pushMany('RB',get('RB').positions,[72,86],Y.D);
      // GK
      if(get('GK').positions) pushMany('GK',get('GK').positions,[46,54],Y.GK);
      const pMap=Object.fromEntries(cfg.positions.map(p=>[p.key,p.players]));
      return out.map(s=>({...s, playersPerPos:pMap[s.key.replace(/[0-9]+$/,'')]||2 }));
    }
    function distribute(n,minX,maxX){ if(n<=1) return [(minX+maxX)/2]; const step=(maxX-minX)/(n-1); return Array.from({length:n},(_,i)=>minX+i*step) }
    const demoFaces = ["https://i.pravatar.cc/100?img=12","https://i.pravatar.cc/100?img=14","https://i.pravatar.cc/100?img=21","https://i.pravatar.cc/100?img=27","https://i.pravatar.cc/100?img=33"];
    function renderPitchPreview(){
      const wrap=document.getElementById('pitchPreview');
      if(!wrap) return;
      wrap.querySelectorAll('.pv-pos').forEach(n=>n.remove());
      if(!(gameType==='football' && isOn(posSwitch))) return;

      const cfg={positions:state.positions, subs_total: state.subs};
      const slots=buildPreviewSlots(cfg); const bookedEvery=2;
      slots.forEach((slot,idx)=>{
        const node=document.createElement('div');
        node.className='pv-pos'; node.style.left=slot.x+'%'; node.style.top=slot.y+'%';
        for(let i=0;i<slot.playersPerPos;i++){
          const s=document.createElement('div'); s.className='pv-slot';
          if((i+idx)%bookedEvery===0){ const img=document.createElement('img'); img.src=demoFaces[(i+idx)%demoFaces.length]; s.appendChild(img); }
          else s.classList.add('empty');
          node.appendChild(s);
        }
        const lbl=document.createElement('div'); lbl.className='pv-label'; lbl.textContent=slot.key; node.appendChild(lbl);
        wrap.appendChild(node);
      });
    }

    // Init render
    renderPosRows();
    refreshVisibility();
    updateTotals();

    // Submit (still UI-first; backend can ignore new fields)
    document.getElementById("submitGameButton").addEventListener("click", async () => {
      const data = {
        session_title: document.getElementById("session_title").value,
        venue: document.getElementById("venue").value,
        game_date: document.getElementById("game_date").value,
        start_time: document.getElementById("start_time").value,
        end_time: document.getElementById("end_time").value,
        level: document.getElementById("level").value,
        play_style: document.getElementById("play_style").value,
        price: parseFloat(document.getElementById("price").value),
        max_players: parseInt(document.getElementById("max_players").value,10),

        // NEW UI flags
        game_type: gameType,
        team_selection: isOn(teamSwitch),
        position_selection: isOn(posSwitch),
        is_public: isOn(publicSwitch),
        is_recurring: isOn(recurSwitch),
        recurrence: {
          weekdays: Array.from(selectedDays.values()).sort(), // 0..6 (Sun..Sat)
          occurrences: clampInt(document.getElementById('recurrences').value,1,52)
        },
        team_a_name: document.getElementById("team_a_name")?.value || 'Team A',
        team_b_name: document.getElementById("team_b_name")?.value || 'Team B',

        // Positions config (for backend later)
        options: { positions: state.positions, subs_total: clampInt(subsEl.value,0,30) }
      };

      try{
        const response = await fetch("https://futbola-backend-fareezedzuans-projects.vercel.app/api/create-game", {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) alert("Game created successfully!");
        else alert("Failed: " + (result?.error || "Unknown error"));
      }catch(err){ alert("Error: " + err.message); }
    });
  </script>
</body>
</html>