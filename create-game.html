<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Game</title>
  <link rel="icon" href="./images/futbola-favicon.ico" type="image/x-icon">
  <style>
    :root { --brand:#ff5a5f; --accent:#702963; }
    body {
      font-family: Arial, sans-serif;
      background-image: url('./images/backgroundOrangeGradient.jpg');
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; overflow-y: auto; margin: 0;
    }
    .container {
      background: white; padding: 30px; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
      width: 100%; max-width: 460px; text-align: left;
      border-top: 5px solid var(--brand);
    }
    h2 { color: var(--accent); margin: 0 0 14px; font-weight: 800; text-align: center; }
    label { display:block; margin-top:12px; font-weight:700; color: var(--brand); }
    input, select {
      width: 100%; padding: 10px; margin-top: 6px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hint { color:#666; font-size:12px; margin-top:6px }
    .switches { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card {
      margin-top: 14px; border:1px solid #eee; border-radius:12px; padding:12px;
      background:#fafafa;
    }
    .card h4 { margin:0 0 8px; color:#333 }
    .flex { display:flex; gap:10px; align-items:center }
    .right { text-align:right }
    .pill { background:#f1f5f9; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; font-size:12px }
    .grid2 { display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px }
    .pos-row { display:grid; grid-template-columns: 1fr 100px 100px; gap:10px; align-items:center; margin-top:8px }
    .pos-row input[type=number] { text-align:center }
    .muted { color:#6b7280; font-size:12px }
    .danger { color:#b91c1c }
    button {
      background-color:#ff0000; color:white; padding:12px 15px; border:none;
      border-radius:8px; font-size:18px; margin-top: 18px; cursor:pointer; width:100%;
    }
    button:hover { background-color:#cc0000 }
    .footer { margin-top: 20px; font-size: 14px; color: #777; text-align:center }
    .hidden { display:none !important }
    .divider { height:1px; background:#eee; margin:10px 0 }
    .badge { background:#fee2e2; color:#991b1b; font-weight:700; padding:2px 8px; border-radius:999px; font-size:12px }
  </style>
</head>
<body>
  <div class="container">
    <h2>Create a New Game</h2>

    <form id="createGameForm">
      <label for="venue">Venue</label>
      <input type="text" id="venue" name="venue" placeholder="e.g. Bangi Uptown Sports" required />

      <div class="row">
        <div>
          <label for="game_date">Game Date</label>
          <input type="date" id="game_date" name="game_date" required />
        </div>
        <div>
          <label for="level">Level</label>
          <select id="level" name="level" required>
            <option value="" disabled selected>Select</option>
            <option value="casual">Casual</option>
            <option value="semi-competitive">Semi-Competitive</option>
            <option value="competitive">Competitive</option>
            <option value="any">All welcome</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="start_time">Start</label>
          <input type="time" id="start_time" name="start_time" required />
        </div>
        <div>
          <label for="end_time">End</label>
          <input type="time" id="end_time" name="end_time" required />
        </div>
      </div>

      <label for="play_style">Play Style / Format</label>
      <input type="text" id="play_style" name="play_style" placeholder="e.g. 5-a-side, 3 teams rotation" required>

      <div class="row">
        <div>
          <label for="price">Price (RM)</label>
          <input type="number" id="price" name="price" min="0" step="0.01" placeholder="e.g. 35.00" required />
        </div>
        <div>
          <label for="max_players">Max Players</label>
          <input type="number" id="max_players" name="max_players" min="1" max="60" required />
        </div>
      </div>

      <div class="divider"></div>

      <!-- NEW: Game Type -->
      <label for="game_type">Game Type</label>
      <select id="game_type" name="game_type" required>
        <option value="futsal">Futsal</option>
        <option value="football">Football (11-a-side)</option>
      </select>
      <p class="hint">Football enables optional team & position booking.</p>

      <!-- NEW: Toggles -->
      <div class="switches">
        <div>
          <label>Team Selection</label>
          <select id="team_selection">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
          <p class="hint">If Yes, players pick Team A or Team B.</p>
        </div>
        <div>
          <label>Position Selection</label>
          <select id="position_selection">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
          <p class="hint">If Yes, players pick specific positions.</p>
        </div>
      </div>

      <!-- NEW: Team names (only when team_selection = yes) -->
      <div id="teamNamesCard" class="card hidden">
        <h4>Team Names</h4>
        <div class="row">
          <div>
            <label for="team_a_name" style="color:#374151;font-weight:600">Team A</label>
            <input id="team_a_name" placeholder="e.g. Futbola CF" />
          </div>
          <div>
            <label for="team_b_name" style="color:#374151;font-weight:600">Team B</label>
            <input id="team_b_name" placeholder="e.g. Visitors" />
          </div>
        </div>
      </div>

      <!-- NEW: Position Config (only when position_selection = yes) -->
      <div id="positionCard" class="card hidden">
        <div class="flex" style="justify-content:space-between">
          <h4>Football Positions & Limits</h4>
          <span class="pill" id="totalSlotsPill">Total Slots: 0</span>
        </div>
        <p class="muted">Toggle how many positions exist and how many players per position. Default preset is Arsenal-like 4-3-3.</p>

        <!-- Header row -->
        <div class="pos-row" style="font-weight:700;color:#374151;margin-top:0">
          <div>Position (label)</div>
          <div>Positions</div>
          <div>Players / Position</div>
        </div>

        <!-- Preset rows -->
        <div id="posRows"></div>

        <div class="divider"></div>
        <div class="grid2">
          <div><strong>Super Subs</strong> <span class="muted">(any position)</span></div>
          <input type="number" id="subs_total" min="0" max="30" value="3"/>
        </div>
        <p class="hint">Common preset → 11 positions × 2 players each (22) + 3 subs = <strong>25</strong> total.</p>
      </div>

      <button type="button" id="submitGameButton">Create Game</button>
    </form>

    <p class="footer">Follow us on Instagram <a href="https://www.instagram.com/futbola_my" target="_blank">@futbola_my</a></p>
  </div>

  <script>
    // --- UI state handling ---
    const gameTypeEl = document.getElementById('game_type');
    const teamSelEl  = document.getElementById('team_selection');
    const posSelEl   = document.getElementById('position_selection');
    const teamCard   = document.getElementById('teamNamesCard');
    const posCard    = document.getElementById('positionCard');
    const posRowsEl  = document.getElementById('posRows');
    const totalPill  = document.getElementById('totalSlotsPill');
    const subsEl     = document.getElementById('subs_total');

    // Default preset (label, positionsCount, playersPerPos)
    const PRESET = [
      { key:'GK',  label:'GK',  positions:1, players:2 },
      { key:'CB',  label:'CB',  positions:2, players:2 }, // total 4
      { key:'LB',  label:'LB',  positions:1, players:2 },
      { key:'RB',  label:'RB',  positions:1, players:2 },
      { key:'DM',  label:'DM',  positions:1, players:2 },
      { key:'CM',  label:'CM',  positions:2, players:2 }, // total 4
      { key:'LW',  label:'LW',  positions:1, players:2 },
      { key:'RW',  label:'RW',  positions:1, players:2 },
      { key:'ST',  label:'ST',  positions:1, players:2 },
    ];

    let state = {
      positions: JSON.parse(JSON.stringify(PRESET)),
      subs: parseInt(subsEl.value,10) || 3
    };

    function renderPosRows(){
      posRowsEl.innerHTML = '';
      state.positions.forEach((p,idx)=>{
        const row = document.createElement('div');
        row.className = 'pos-row';
        row.innerHTML = `
          <div class="flex"><span class="pill">${p.key}</span>
            <input style="margin-left:8px" value="${p.label}" aria-label="${p.key} label"/>
          </div>
          <input type="number" min="0" max="11" value="${p.positions}" aria-label="${p.key} positions"/>
          <input type="number" min="0" max="10" value="${p.players}" aria-label="${p.key} players"/>
        `;
        // Wire inputs
        const [labelEl, posCountEl, playersEl] = row.querySelectorAll('input');
        labelEl.addEventListener('input', e => { state.positions[idx].label = e.target.value; updateTotals(); });
        posCountEl.addEventListener('input', e => { state.positions[idx].positions = clampInt(e.target.value,0,11); updateTotals(); });
        playersEl.addEventListener('input', e => { state.positions[idx].players = clampInt(e.target.value,0,10); updateTotals(); });

        posRowsEl.appendChild(row);
      });
      updateTotals();
    }

    function clampInt(v,min,max){ v=parseInt(v||0,10); return isNaN(v)?min:Math.max(min,Math.min(max,v)); }

    function updateTotals(){
      state.subs = clampInt(subsEl.value,0,30);
      const total = state.positions.reduce((sum,p)=> sum + (p.positions * p.players), 0) + state.subs;
      totalPill.textContent = `Total Slots: ${total}`;
      // Suggest max_players by default (only if football + position selection on)
      const gt = gameTypeEl.value;
      if (gt==='football' && posSelEl.value==='yes'){
        const maxInput = document.getElementById('max_players');
        if (maxInput && (!maxInput.value || +maxInput.value < total)) maxInput.value = total;
      }
    }

    // Show/hide cards on change
    function refreshVisibility(){
      const isFootball = gameTypeEl.value === 'football';
      teamCard.classList.toggle('hidden', teamSelEl.value !== 'yes');
      posCard.classList.toggle('hidden', !(isFootball && posSelEl.value === 'yes'));
    }

    gameTypeEl.addEventListener('change', refreshVisibility);
    teamSelEl.addEventListener('change', refreshVisibility);
    posSelEl.addEventListener('change', refreshVisibility);
    subsEl.addEventListener('input', updateTotals);

    // Initial render
    renderPosRows();
    refreshVisibility();

    // --- Submit (still posts to your current endpoint) ---
    document.getElementById("submitGameButton").addEventListener("click", async () => {
      const data = {
        venue: document.getElementById("venue").value,
        game_date: document.getElementById("game_date").value,
        start_time: document.getElementById("start_time").value,
        end_time: document.getElementById("end_time").value,
        level: document.getElementById("level").value,
        play_style: document.getElementById("play_style").value,
        price: parseFloat(document.getElementById("price").value),
        max_players: parseInt(document.getElementById("max_players").value,10),

        // NEW (UI only for now)
        game_type: document.getElementById("game_type").value,
        team_selection: document.getElementById("team_selection").value === 'yes',
        position_selection: document.getElementById("position_selection").value === 'yes',
        team_a_name: document.getElementById("team_a_name")?.value || 'Team A',
        team_b_name: document.getElementById("team_b_name")?.value || 'Team B',

        // store all the position config together (backend can ignore until ready)
        options: {
          positions: state.positions, // [{key,label,positions,players},...]
          subs_total: clampInt(subsEl.value,0,30)
        }
      };

      try {
        const response = await fetch("https://futbola-backend-fareezedzuans-projects.vercel.app/api/create-game", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok) { alert("Game created successfully!"); }
        else { alert("Failed: " + (result?.error || 'Unknown error')); }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>